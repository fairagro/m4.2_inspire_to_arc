#!/usr/bin/env bash
# Combined pre-push hook: Git LFS + pre-commit
# This file is version-controlled and should be installed via scripts/setup-git-hooks.sh

# Git LFS pre-push hook
command -v git-lfs >/dev/null 2>&1 || {
    echo >&2 "\nThis repository is configured for Git LFS but 'git-lfs' was not found on your path."
    echo >&2 "Please install git-lfs or run: sudo apt-get install git-lfs"
    echo >&2 "If you no longer wish to use Git LFS, remove this hook by deleting '.git/hooks/pre-push'.\n"
    exit 2
}
git lfs pre-push "$@"

# Pre-commit hook - find the correct Python and run pre-commit
INSTALL_PYTHON=""
if [ -f ".venv/bin/python3" ]; then
    INSTALL_PYTHON="$(pwd)/.venv/bin/python3"
elif [ -f ".venv/bin/python" ]; then
    INSTALL_PYTHON="$(pwd)/.venv/bin/python"
fi

ARGS=(hook-impl --config=.pre-commit-config.yaml --hook-type=pre-push)
HERE="$(cd "$(dirname "$0")" && pwd)"
ARGS+=(--hook-dir "$HERE" -- "$@")

if [ -x "$INSTALL_PYTHON" ]; then
    exec "$INSTALL_PYTHON" -mpre_commit "${ARGS[@]}"
elif command -v pre-commit > /dev/null; then
    exec pre-commit "${ARGS[@]}"
else
    echo '`pre-commit` not found. Did you forget to activate your virtualenv?' 1>&2
    exit 1
fi
