name: Docker Build and Test (Reusable)

on:
  workflow_call:
    inputs:
      push_to_registry:
        description: 'Whether to push to DockerHub registry'
        required: false
        type: boolean
        default: false

      version_bump:
        description: 'Version bump type for GitVersion'
        required: false
        type: string
        default: 'patch'
      components:
        description: 'A JSON string array of components to build'
        required: false
        type: string
        default: '["sql_to_arc"]'
    outputs:
      version:
        description: 'Calculated version'
        value: ${{ jobs.calculate-version.outputs.version }}
      SemVer:
        description: 'Semantic version'
        value: ${{ jobs.calculate-version.outputs.SemVer }}
      Major:
        description: 'Major version'
        value: ${{ jobs.calculate-version.outputs.Major }}
      Minor:
        description: 'Minor version'
        value: ${{ jobs.calculate-version.outputs.Minor }}
      image-digest:
        description: 'Docker image digest'
        value: ${{ jobs.build-docker-image.outputs.image-digest }}
      dockerhub-pushed:
        description: 'Whether image was pushed to DockerHub'
        value: ${{ jobs.build-docker-image.outputs.dockerhub-pushed }}
      components:
        description: 'A JSON string array of components that were built'
        value: ${{ jobs.calculate-version.outputs.components }}

# Environment variables with fallback values
# Repository variables (vars.*) are optional and will use defaults if not configured
env:
  GIT_USER_NAME: ${{ vars.GIT_USER_NAME || 'GitHub Pipeline' }}
  GIT_USER_EMAIL: ${{ vars.GIT_USER_EMAIL || 'github_pipeline@fairagro.net' }}
  DOCKERHUB_NAMESPACE: ${{ vars.DOCKERHUB_NAMESPACE || 'zalf' }}
  IMAGE_BASE_NAME: ${{ vars.IMAGE_BASE_NAME || 'fairagro-advanced-middleware' }}
  IMAGE_TITLE: ${{ vars.IMAGE_TITLE || 'FAIRagro SQL-to-ARC' }}
  IMAGE_DESCRIPTION: ${{ vars.IMAGE_DESCRIPTION || 'Middleware for converting SQL metadata to ARC format for FAIRagro' }}
  GITVERSION_TAG_PREFIX: ${{ vars.GITVERSION_TAG_PREFIX || '.*-docker-v' }}
  DOCKER_PLATFORMS: ${{ vars.DOCKER_PLATFORMS || 'linux/amd64' }}

jobs:
  calculate-version:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      version: ${{ env.IS_FEATURE_BRANCH == 'true' && steps.gitversion.outputs.semVer || steps.gitversion.outputs.majorMinorPatch }}
      SemVer: ${{ steps.gitversion.outputs.semVer }}
      Major: ${{ steps.gitversion.outputs.major }}
      Minor: ${{ steps.gitversion.outputs.minor }}
      Patch: ${{ steps.gitversion.outputs.patch }}
      components: ${{ inputs.components }}
    env:
      IS_FEATURE_BRANCH: ${{ startsWith(github.ref_name, 'feature/') }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: gittools/actions/gitversion/setup@v4
        with:
          versionSpec: '6.4.x'

      - name: Create GitVersion config
        uses: DamianReeves/write-file-action@master
        with:
          path: GitVersion.yml
          write-mode: overwrite
          contents: |
            mode: ContinuousDeployment
            tag-prefix: '${{ env.GITVERSION_TAG_PREFIX }}'
            semantic-version-format: Strict
            branches:
              main:
                label: ''
                increment: ${{ inputs.version_bump }}
              feature:
                regex: ^feature/(?<BranchName>.+)$
                label: '{BranchName}'
                increment: Inherit
                track-merge-target: false

      - name: Execute GitVersion
        id: gitversion
        uses: gittools/actions/gitversion/execute@v4

      - name: Debug version info
        run: |
          echo "üîß Version Bump Configuration:"
          echo "  - Input version_bump: ${{ inputs.version_bump }}"
          echo "  - Branch: ${{ github.ref_name }}"
          echo "  - Is feature branch: ${{ env.IS_FEATURE_BRANCH }}"
          echo ""
          echo "üìä GitVersion Results:"
          echo "  - SemVer: ${{ steps.gitversion.outputs.semVer }}"
          echo "  - MajorMinorPatch: ${{ steps.gitversion.outputs.majorMinorPatch }}"
          echo "  - Final version: ${{ env.IS_FEATURE_BRANCH == 'true' && steps.gitversion.outputs.semVer || steps.gitversion.outputs.majorMinorPatch }}"

  build-docker-image:
    needs: calculate-version
    strategy:
      matrix:
        component: ${{ fromJson(inputs.components) }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
      dockerhub-pushed: ${{ env.DOCKERHUB_AVAILABLE == 'true' && inputs.push_to_registry }}

    env:
      DOCKERHUB_AVAILABLE: ${{ secrets.DOCKERHUB_USER != '' && secrets.DOCKERHUB_TOKEN != '' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        if: env.DOCKERHUB_AVAILABLE == 'true' && inputs.push_to_registry
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set component-specific metadata
        id: component-meta
        run: |
          case "${{ matrix.component }}" in
            sql_to_arc)
              echo "title=FairAgro SQL to ARC Converter" >> $GITHUB_OUTPUT
              echo "description=Converts SQL database metadata to ARC format for FairAgro platform" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "title=FairAgro Advanced Middleware Component: ${{ matrix.component }}" >> $GITHUB_OUTPUT
              echo "description=Middleware component for FairAgro platform" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.DOCKERHUB_AVAILABLE == 'true' && inputs.push_to_registry && format('{0}/{1}-{2}', env.DOCKERHUB_NAMESPACE, env.IMAGE_BASE_NAME, matrix.component) || '' }}
          tags: |
            type=semver,pattern={{version}},value=${{ needs.calculate-version.outputs.SemVer }}
            type=raw,value=${{ needs.calculate-version.outputs.version }}
            type=raw,value=${{ needs.calculate-version.outputs.Major }}.${{ needs.calculate-version.outputs.Minor }},enable=${{ !contains(github.ref_name, 'feature/') }}
            type=raw,value=${{ needs.calculate-version.outputs.Major }},enable=${{ !contains(github.ref_name, 'feature/') }}
            type=raw,value=latest,enable=${{ !contains(github.ref_name, 'feature/') }}
          labels: |
            org.opencontainers.image.title=${{ steps.component-meta.outputs.title }}
            org.opencontainers.image.description=${{ steps.component-meta.outputs.description }}
            org.opencontainers.image.url=https://github.com/${{ github.repository }}
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.version=v${{ needs.calculate-version.outputs.version }}
            org.opencontainers.image.created=${{ github.event.repository.updated_at }}
            org.opencontainers.image.revision=${{ github.sha }}

      - name: Build Docker image
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile.${{ matrix.component }}
          platforms: linux/amd64
          push: ${{ env.DOCKERHUB_AVAILABLE == 'true' && inputs.push_to_registry }}
          load: true
          tags: ${{ env.DOCKERHUB_AVAILABLE == 'true' && inputs.push_to_registry && steps.meta.outputs.tags || format('local/{0}-{1}:{2}', env.IMAGE_BASE_NAME, matrix.component, needs.calculate-version.outputs.version) }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            APP_VERSION=${{ needs.calculate-version.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Save Docker image as artifact
        run: |
          # Use the DockerHub tag if pushed, otherwise local tag
          if [[ "${{ env.DOCKERHUB_AVAILABLE }}" == "true" && "${{ inputs.push_to_registry }}" == "true" ]]; then
            IMAGE_TAG="${{ env.DOCKERHUB_NAMESPACE }}/${{ env.IMAGE_BASE_NAME }}-${{ matrix.component }}:${{ needs.calculate-version.outputs.version }}"
          else
            IMAGE_TAG="local/${{ env.IMAGE_BASE_NAME }}-${{ matrix.component }}:${{ needs.calculate-version.outputs.version }}"
          fi
          echo "Saving image: $IMAGE_TAG"
          docker save "$IMAGE_TAG" | gzip > docker-image-${{ matrix.component }}.tar.gz

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image-${{ matrix.component }}-${{ needs.calculate-version.outputs.version }}
          path: docker-image-${{ matrix.component }}.tar.gz
          retention-days: 1

      - name: Log push status
        run: |
          if [[ "${{ env.DOCKERHUB_AVAILABLE }}" == "true" && "${{ inputs.push_to_registry }}" == "true" ]]; then
            echo "‚úÖ Image pushed to DockerHub"
          else
            echo "‚è≠Ô∏è DockerHub push skipped"
          fi

  container-structure-test:
    needs: [calculate-version, build-docker-image]
    strategy:
      matrix:
        component: ${{ fromJson(inputs.components) }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    if: needs.build-docker-image.result == 'success'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image-${{ matrix.component }}-${{ needs.calculate-version.outputs.version }}

      - name: Load Docker image
        run: |
          echo "üì¶ Loading Docker image from artifact..."
          docker load < docker-image-${{ matrix.component }}.tar.gz

          # List loaded images for verification
          echo "üîç Loaded images:"
          docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}"

      - name: Determine image tag for tests
        id: image-tag
        run: |
          DOCKERHUB_AVAILABLE="${{ secrets.DOCKERHUB_USER != '' && secrets.DOCKERHUB_TOKEN != '' }}"
          PUSH_TO_REGISTRY="${{ inputs.push_to_registry }}"

          if [[ "$DOCKERHUB_AVAILABLE" == "true" && "$PUSH_TO_REGISTRY" == "true" ]]; then
            IMAGE_TAG="${{ env.DOCKERHUB_NAMESPACE }}/${{ env.IMAGE_BASE_NAME }}-${{ matrix.component }}:${{ needs.calculate-version.outputs.version }}"
            echo "Using DockerHub image: $IMAGE_TAG"
          else
            IMAGE_TAG="local/${{ env.IMAGE_BASE_NAME }}-${{ matrix.component }}:${{ needs.calculate-version.outputs.version }}"
            echo "Using local image: $IMAGE_TAG"
          fi

          echo "image-tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

          # Verify image exists
          echo "üîç Checking if image exists..."
          if docker image inspect "$IMAGE_TAG" > /dev/null 2>&1; then
            echo "‚úÖ Image found: $IMAGE_TAG"
          else
            echo "‚ùå Image not found: $IMAGE_TAG"
            echo "Available images:"
            docker images
            exit 1
          fi

      - name: Run Container Structure Tests
        uses: plexsystems/container-structure-test-action@v0.3.0
        with:
          image: ${{ steps.image-tag.outputs.image-tag }}
          config: docker/container-structure-tests/${{ matrix.component }}.yaml

      - name: Summary
        if: always()
        run: |
          echo "## üê≥ Container Structure Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "**Component**: ${{ matrix.component }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: v${{ needs.calculate-version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Config**: docker/container-structure-tests/${{ matrix.component }}.yaml" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "‚úÖ **All container structure tests passed!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Container structure tests failed!**" >> $GITHUB_STEP_SUMMARY
          fi
