name: Reusable Release

on:
  workflow_call:
    inputs:
      version:
        description: 'Version calculated in Build phase'
        required: true
        type: string
      components:
        description: 'A JSON string array of components to release'
        required: false
        type: string
        default: '["inspire_to_arc"]'
      release_type:
        description: 'Type of release (feature or final)'
        required: true
        type: string
    secrets:
      DOCKERHUB_USER:
        required: true
      DOCKERHUB_TOKEN:
        required: true

env:
  GIT_USER_NAME: ${{ vars.GIT_USER_NAME || 'GitHub Pipeline' }}
  GIT_USER_EMAIL: ${{ vars.GIT_USER_EMAIL || 'github_pipeline@fairagro.net' }}
  IMAGE_BASE_NAME: ${{ vars.IMAGE_BASE_NAME || 'fairagro-advanced-middleware' }}
  DOCKERHUB_NAMESPACE: ${{ vars.DOCKERHUB_NAMESPACE || 'zalf' }}
  GHCR_NAMESPACE: ${{ github.repository_owner }}

jobs:
  docker-push:
    name: DockerPush/Release
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        component: ${{ fromJson(inputs.components) }}
    
    steps:
      - name: Download Docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image-${{ matrix.component }}-${{ inputs.version }}

      - name: Load Docker image
        run: |
          docker load < docker-image-${{ matrix.component }}.tar.gz
          LOCAL_TAG="local/${{ env.IMAGE_BASE_NAME }}-${{ matrix.component }}:${{ inputs.version }}"
          echo "LOCAL_TAG=$LOCAL_TAG" >> $GITHUB_ENV

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Tag and Push Images
        run: |
          # DockerHub
          DH_TAG="${{ env.DOCKERHUB_NAMESPACE }}/${{ env.IMAGE_BASE_NAME }}-${{ matrix.component }}:${{ inputs.version }}"
          docker tag ${{ env.LOCAL_TAG }} $DH_TAG
          docker push $DH_TAG
          echo "✅ Pushed to DockerHub: $DH_TAG"

          # GHCR
          # GHCR requires lowercase repository name
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          GHCR_TAG="ghcr.io/$REPO_LOWER/${{ matrix.component }}:${{ inputs.version }}"
          docker tag ${{ env.LOCAL_TAG }} $GHCR_TAG
          docker push $GHCR_TAG
          echo "✅ Pushed to GHCR: $GHCR_TAG"

  create-release-tag:
    name: CreateReleaseTag/Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create version tag
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          custom_tag: ${{ inputs.version }}
          tag_prefix: "v" 
          create_annotated_tag: true

  github-release:
    name: GithubRelease/Release
    needs: [docker-push, create-release-tag]
    if: inputs.release_type == 'final'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ inputs.version }}"
          name: "Release v${{ inputs.version }}"
          generate_release_notes: true
          make_latest: true
