# Container Structure Test Configuration for SQL to ARC Converter
# Tests the built Docker image for security, structure, and functionality
# Documentation: https://github.com/GoogleContainerTools/container-structure-test

schemaVersion: 2.0.0

# File existence tests
fileExistenceTests:
  - name: 'SQL to ARC executable'
    path: '/middleware/sql_to_arc/sql_to_arc'
    shouldExist: true
    permissions: '-rwxr-xr-x'  # Executable

  - name: 'No Python wheels in final image'
    path: '/tmp/wheels'
    shouldExist: false  # Wheels should not leak into runtime

  - name: 'No source code in final image'
    path: '/build'
    shouldExist: false  # Build artifacts should not be in runtime

  - name: 'No middleware source directory in final image'
    path: '/build/middleware'
    shouldExist: false  # Source code should not be in runtime

# File content tests
fileContentTests:
  - name: 'Non-root user created'
    path: '/etc/passwd'
    expectedContents: ['sql_to_arc:.*']

  - name: 'Non-root group created'
    path: '/etc/group'
    expectedContents: ['sql_to_arc:.*']

# Command tests
commandTests:
  - name: 'Python is not in final image (security)'
    command: 'sh'
    args: ['-lc', 'command -v python3']
    exitCode: 127  # Command not found - Python not in final image (security)

  - name: 'Pip is not in final image (security)'
    command: 'sh'
    args: ['-lc', 'command -v pip']
    exitCode: 127  # pip should not be in runtime for security

  - name: 'UV is not in final image (security)'
    command: 'sh'
    args: ['-lc', 'command -v uv']
    exitCode: 127  # uv should not be in runtime

  - name: 'PyInstaller is not in final image (security)'
    command: 'sh'
    args: ['-lc', 'command -v pyinstaller']
    exitCode: 127  # pyinstaller should not be in runtime

  - name: 'SQL to ARC binary is executable'
    command: 'test'
    args: ['-x', '/middleware/sql_to_arc']
    exitCode: 0

  - name: 'Minimal package count (Alpine security)'
    command: 'sh'
    args: ['-lc', 'apk info | wc -l']
    exitCode: 0
    # Alpine should have minimal packages (typically < 20 for this image)

# Metadata tests
metadataTest:
  user: 'sql_to_arc'
  workdir: '/middleware'
