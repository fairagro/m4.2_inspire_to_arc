# ---- Package Build Stage ----
FROM python:3.12.12-alpine3.23 AS package-builder

WORKDIR /build

# Copy project files needed for package build
COPY pyproject.toml uv.lock ./
COPY middleware ./middleware

# Upgrade pip and install uv
RUN pip install --no-cache-dir --upgrade pip==25.3 uv==0.9.27

# Declare build argument for versioning
ARG APP_VERSION=0.0.0

# We prefer to build a wheel for our package first. This ensures we have a clean,
# distributable artifact that contains only the necessary files.
# We set SETUPTOOLS_SCM_PRETEND_VERSION so hatch-vcs can work without .git folder.
RUN SETUPTOOLS_SCM_PRETEND_VERSION=${APP_VERSION#v} uv build --package sql_to_arc --wheel


# ---- Binary Build Stage ----
FROM python:3.12.12-alpine3.23 AS binary-builder

# Install build tools for PyInstaller
RUN apk add --no-cache \
    build-base=0.5-r3 \
    python3-dev=3.12.12-r0 \
    libffi-dev=3.5.2-r0 \
    openssl-dev=3.5.5-r0 \
    cargo=1.91.1-r0 \
    git=2.52.0-r0

WORKDIR /build

# Install uv core tool
RUN pip install --no-cache-dir --upgrade pip==25.3 uv==0.9.27

# Bring in the pre-built wheel and project metadata
COPY --from=package-builder /build/dist/*.whl /tmp/wheels/
COPY pyproject.toml uv.lock ./

# We still need the source code because uv sync requires all workspace members (e.g., middleware/sql_to_arc)
# to be physically present to validate the environment against the lockfile.
COPY middleware ./middleware

# Dependency Resolution Strategy:
# 1. We would prefer to install everything as wheels for speed and reliability.
# 2. However, some dependencies (especially git-based ones like api_client) are not available
#    as pre-built wheels on PyPI.
# 3. Thus, we use 'uv sync' to create a virtual environment (.venv) and resolve all
#    complex dependencies exactly as specified in the uv.lock.
RUN uv sync --no-dev

# 4. Finally, for packages like sql_to_arc that exist both as a workspace dependency
#    and as a pre-built wheel, we explicitly 'uv pip install' the wheel. This ensures
#    we use our optimized, pre-built package instead of the 'editable' source install.
ARG APP_VERSION=0.0.0
RUN SETUPTOOLS_SCM_PRETEND_VERSION=${APP_VERSION#v} uv pip install /tmp/wheels/*.whl pyinstaller

# Build standalone binary using the .venv's context.
RUN . .venv/bin/activate && \
    python -m PyInstaller --onedir \
    --name sql_to_arc \
    /build/middleware/sql_to_arc/src/middleware/sql_to_arc/main.py


# ---- Runtime Stage ----
FROM alpine:3.23.3

WORKDIR /middleware

# Create non-root user and group
RUN addgroup -S sql_to_arc && \
    adduser -S -H -G sql_to_arc sql_to_arc

# Copy the entire directory created by --onedir with correct ownership
COPY --chown=sql_to_arc:sql_to_arc --from=binary-builder /build/dist/sql_to_arc /middleware/sql_to_arc

USER sql_to_arc

# Execute the binary inside the directory
CMD ["/middleware/sql_to_arc/sql_to_arc"]
